#!/bin/bash

# Global Configuration
VERSION="1.0.1"
CONFIG_DIR="/etc/mynas"
LOG_DIR="/var/log/mynas"
BACKUP_DIR="/mnt/backups"
TEMP_DIR="/tmp/mynas"
POLICY_DIR="/etc/mynas/policies"
GROUPS_CONF="$CONFIG_DIR/groups.conf"
POLICIES_CONF="$CONFIG_DIR/policies.conf"
SHARES_CONF="$CONFIG_DIR/shares.conf"




# Distribution Detection
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO=$ID
        DISTRO_VERSION=$VERSION_ID
    elif type lsb_release >/dev/null 2>&1; then
        DISTRO=$(lsb_release -si | tr '[:upper:]' '[:lower:]')
        DISTRO_VERSION=$(lsb_release -sr)
    else
        log "ERROR: Could not detect Linux distribution!"
        exit 1
    fi

    case $DISTRO in
        debian|ubuntu)
            PKG_MANAGER="apt"
            INSTALL_CMD="apt install -y --no-install-recommends"
            UPDATE_CMD="apt update && apt upgrade -y"
            NFS_SERVICE="nfs-kernel-server"
            FIREWALL_TYPE="firewalld"
            ;;
        opensuse*|suse)
            PKG_MANAGER="zypper"
            INSTALL_CMD="zypper install -y"
            UPDATE_CMD="zypper refresh && zypper update -y"
            NFS_SERVICE="nfs-server"
            FIREWALL_TYPE="firewalld"
            ;;
        *)
            log "ERROR: Unsupported distribution: $DISTRO"
            exit 1
            ;;
    esac

    log "Detected distribution: $DISTRO $DISTRO_VERSION"
    log "Using firewall type: $FIREWALL_TYPE"
}

# Initialize directories and logging
init() {
    mkdir -p "$CONFIG_DIR" "$LOG_DIR" "$BACKUP_DIR" "$TEMP_DIR"
    if [ ! -f "$GROUPS_CONF" ]; then
        echo "# Group Configuration" > "$GROUPS_CONF"
        echo "# Format: groupname:user1,user2,user3" >> "$GROUPS_CONF"
    fi
    
    if [ ! -f "$POLICIES_CONF" ]; then
        echo "# Access Policies Configuration" > "$POLICIES_CONF"
        echo "# Format: policy_name:group:path:permissions:recursive" >> "$POLICIES_CONF"
        echo "# permissions: r=read, w=write, x=execute, l=list, n=none" >> "$POLICIES_CONF"
    fi
    
    if [ ! -f "$SHARES_CONF" ]; then
        echo "# Shares Configuration" > "$SHARES_CONF"
        echo "# Format: share_name:path:owner_group:access_groups:permissions" >> "$SHARES_CONF"
    fi
    local timestamp=$(date +"%Y%m%d_%H%M%S")
    LOG_FILE="$LOG_DIR/mynas_$timestamp.log"
    exec 3>&1 4>&2
    exec > >(tee -a "$LOG_FILE") 2>&1
    
    detect_distro
}

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $@" | tee -a "$LOG_FILE"
}

# Error handling
die() {
    log "ERROR: $@"
    exit 1
}

# Backup configuration file
backup_file() {
    local f="$1"
    if [[ -f "$f" ]] && [[ ! -f "${f}.bak" ]]; then
        cp -a "$f" "${f}.bak"
        log "Backed up $f to ${f}.bak"
    fi
}

# Show help information
show_help() {
    echo "Enterprise NAS Management Tool v$VERSION"
    echo "Usage: mynas [GLOBAL_OPTIONS] -- [MODULE] -- [ACTION] [OPTIONS]"
    echo ""
    echo "Global Options:"
    echo "  --help, -h     Show this help message"
    echo "  --version, -v  Show version information"
    echo "  --verbose      Enable verbose output"
    echo "  --monitor      Enable monitoring features"
    echo "  --disk-health  Check disk health"
    echo ""
    echo "Modules:"
    echo "  --backup       Backup management"
    echo "  --av           Antivirus management (clamav, maldet, rkhunter, chkrootkit)"
    echo "  --system       System management"
    echo "  --monitor      Monitoring management"
    echo "  --storage      Storage management"
    echo "  --nfs          NFS management"
    echo "  --samba        Samba management"
    echo "  --sshfs        SSHFS management"
    echo "  --firewall     Firewall management (firewalld)"
    echo "  --fail2ban     Fail2ban management"
    echo "  --raid         RAID management"
    echo "  --network      Network management"
    echo "  --service      Service management"
    echo "  --user         User management"
    echo "  --group        Group management"
    echo "  --policy       Access policy management"
    echo "  --share        Share management"
    echo "  --permission   File permission management"
    echo "  --lvm           LVM management"
    echo "  --fs-advanced   Advanced filesystem management"
    echo ""
    echo "Run 'mynas --help --[MODULE]' for module-specific help"
    echo "All operations are logged to $LOG_DIR"
}

# Module-specific help
module_help() {
    local module="$1"
    case "$module" in
        backup)
            echo "Backup Module Commands:"
            echo "  --tar <source> [dest]          Create tar backup"
            echo "  --zip <source> [dest]          Create zip backup"
            echo "  --dd <source> [dest]           Create disk clone"
            ;;
        av)
            echo "Antivirus Module Commands:"
            echo "  --clamav <path>                Run ClamAV scan"
            echo "  --maldet <path>                Run Maldet scan"
            echo "  --rkhunter                     Run Rootkit Hunter scan"
            echo "  --chkrootkit                   Run chkrootkit scan"
            echo "  --update-databases             Update all AV databases"
            echo "  --clamav-schedule <path>       Schedule weekly ClamAV scan"
            echo "  --maldet-monitor <path>        Enable Maldet monitoring"
            ;;
        system)
            echo "System Module Commands:"
            echo "  --update                       Update system packages"
            ;;
        monitor)
            echo "Monitor Module Commands:"
            echo "  --iostat [interval] [count]    Run iostat monitoring"
            echo "  --netdata <start|stop|restart|status>  Manage netdata service"
            echo "  --disk-health                  Check disk health with SMART"
            ;;
        storage)
            echo "Storage Module Commands:"
            echo "  --list                         List storage devices"
            echo "  --format <device> [fstype]     Format device (default: ext4)"
            echo "  --mount <device> <mountpoint>  Mount device"
            echo "  --umount <mountpoint>          Unmount device"
            echo "  --info <device>                Show device information"
            ;;
        nfs)
            echo "NFS Module Commands:"
            echo "  --install                      Install NFS server"
            echo "  --add-share <path> <clients> [options]  Add NFS share"
            ;;
        samba)
            echo "Samba Module Commands:"
            echo "  --install                      Install Samba"
            echo "  --add-share <name> <path> <users> [writable]  Add Samba share"
            ;;
        sshfs)
            echo "SSHFS Module Commands:"
            echo "  --install                      Install SSHFS"
            echo "  --mount <user> <host> <remote_path> <local_path>  Mount SSHFS"
            ;;
        firewall)
            echo "Firewall Module Commands:"
            echo "  --add-port <port> [proto]      Add port to firewall"
            echo "  --remove-port <port> [proto]   Remove port from firewall"
            echo "  --add-service <service>         Add service to firewall"
            echo "  --remove-service <service>      Remove service from firewall"
            echo "  --list                         List firewall configuration"
            ;;
        fail2ban)
            echo "Fail2ban Module Commands:"
            echo "  --install                      Install fail2ban"
            echo "  --enable-jail <jail>           Enable fail2ban jail"
            echo "  --disable-jail <jail>          Disable fail2ban jail"
            echo "  --status                       Show fail2ban status"
            ;;
        raid)
            echo "RAID Module Commands:"
            echo "  --create <level> <devices> [name]  Create RAID array"
            echo "  --add <array> <device>          Add device to RAID array"
            echo "  --remove <array> <device>       Remove device from RAID array"
            echo "  --stop <array>                  Stop RAID array"
            echo "  --status                        Show RAID status"
            echo "  --save                          Save RAID configuration"
            ;;
        network)
            echo "Network Module Commands:"
            echo "  --list-interfaces              List network interfaces"
            echo "  --set-ip <iface> <ip> [netmask]  Set IP address"
            echo "  --set-gateway <gw>             Set default gateway"
            echo "  --set-dns <dns>                Set DNS server"
            echo "  --test                         Test network connectivity"
            echo "  --bridge <name> <ifaces>       Create network bridge"
            echo "  --bond <name> <mode> <ifaces>  Create network bond"
            ;;
        service)
            echo "Service Module Commands:"
            echo "  --start <service>              Start service"
            echo "  --stop <service>               Stop service"
            echo "  --restart <service>            Restart service"
            echo "  --enable <service>             Enable service"
            echo "  --disable <service>            Disable service"
            echo "  --status <service>             Show service status"
            echo "  --mask <service>               Mask service"
            echo "  --unmask <service>             Unmask service"
            ;;
        lvm)
            echo "LVM Module Commands:"
            echo "  --create-pv <device>           Create physical volume"
            echo "  --create-vg <name> <pvs>       Create volume group"
            echo "  --create-lv <vg> <name> <size> Create logical volume"
            echo "  --extend-lv <lv> <size>        Extend logical volume"
            echo "  --reduce-lv <lv> <size>        Reduce logical volume"
            echo "  --list-pv                     List physical volumes"
            echo "  --list-vg                     List volume groups"
            echo "  --list-lv                     List logical volumes"
            echo "  --remove-lv <lv>              Remove logical volume"
            echo "  --remove-vg <vg>              Remove volume group"
            echo "  --remove-pv <pv>              Remove physical volume"
            ;;
        fs-advanced)
            echo "Advanced Filesystem Module Commands:"
            echo "  --resize <device> [size]        Resize filesystem"
            echo "  --check <device> [fstype]       Check filesystem"
            echo "  --label <device> <label> [fstype] Set filesystem label"
            echo "  --tune <device> <option> <value> Tune filesystem parameters"
            echo "  --defrag <mountpoint>           Defragment filesystem"
            echo "  --swap <device> <action>        Manage swap space"
            echo ""
            echo "Tune options:"
            echo "  reserved <percentage>    Set reserved blocks percentage"
            echo "  mounts <count>           Set maximum mount count"
            echo "  interval <time>          Set check interval (time)"
            echo ""
            echo "Swap actions:"
            echo "  create    - Create and enable swap"
            echo "  enable    - Enable existing swap"
            echo "  disable   - Disable swap"
            echo "  remove    - Remove swap from fstab"
            echo "  status    - Show swap status"
            ;;
        user)
            echo "User Module Commands:"
            echo "  --add <user> [shell]           Add user"
            echo "  --remove <user>                Remove user"
            echo "  --list                         List users"
            echo "  --passwd <user>                Change user password"
            echo "  --add-to-group <user> <group>  Add user to group"
            echo "  --remove-from-group <user> <group>  Remove user from group"
            echo "  --list-groups <user>           List user groups"
            echo "  --lock <user>                  Lock user account"
            echo "  --unlock <user>                Unlock user account"
            ;;
        group)
            echo "Group Module Commands:"
            echo "  --create <group>               Create new group"
            echo "  --delete <group>               Delete group"
            echo "  --adduser <group> <user>       Add user to group"
            echo "  --removeuser <group> <user>    Remove user from group"
            echo "  --list [group]                 List all groups or group members"
            echo "  --setowner <group> <user>      Set group owner with directory"
            ;;
        policy)
            echo "Policy Module Commands:"
            echo "  --create <policy> <group> <path> <perms> [recursive]"
            echo "                                  Create access policy"
            echo "  --delete <policy>               Delete policy"
            echo "  --apply <policy>                Apply policy to filesystem"
            echo "  --applyall                      Apply all policies"
            echo "  --list [policy]                 List all policies or policy details"
            echo "  --test <user> <path>            Test user access to path"
            echo ""
            echo "Permission codes:"
            echo "  r    - Read only"
            echo "  rw   - Read/Write"
            echo "  rwx  - Read/Write/Execute"
            echo "  none - No access"
            ;;
        share)
            echo "Share Module Commands:"
            echo "  --create <name> <path> <owner_group> <access_groups> [perms]"
            echo "                                  Create new share"
            echo "  --delete <share>                Delete share"
            echo "  --addgroup <share> <group>      Add group to share access"
            echo "  --removegroup <share> <group>   Remove group from share"
            echo "  --list                         List all shares"
            echo "  --info <share>                  Show share details"
            ;;
        permission)
            echo "Permission Module Commands:"
            echo "  --set <path> [owner] [group] [perms]  Set permissions"
            echo "  --fix <path>                   Fix permissions recursively"
            echo "  --inherit <path>               Set up permission inheritance"
            echo "  --check <path> [user]          Check permissions"
            echo "  --reset <path>                 Reset to default permissions"
            ;;

        *)

            show_help
            ;;
    esac
}

# ==================== MONITORING FUNCTIONS ====================

monitor_iostat() {
    local interval=${1:-2}
    local count=${2:-5}
    
    if ! command -v iostat &> /dev/null; then
        log "Installing sysstat package for iostat..."
        eval $INSTALL_CMD sysstat
    fi
    
    log "Running iostat (Interval: ${interval}s, Count: ${count})"
    iostat -dxm $interval $count
}

monitor_netdata() {
    NETDATA_PORT=19999

    get_ip() {
        hostname -I | awk '{print $1}'
    }

    case "$1" in
        start|stop|restart|status)
            systemctl "$1" netdata
            if [ "$1" = "start" ]; then
                IP=$(get_ip)
                log "Netdata started at: http://${IP}:${NETDATA_PORT}"
            fi
            ;;
        *)
            die "Invalid netdata command: $1"
            ;;
    esac
}

check_disk_health() {
    log "Checking disk health with SMART..."
    
    if ! command -v smartctl &> /dev/null; then
        log "Installing smartmontools..."
        eval $INSTALL_CMD smartmontools
    fi
    
    for disk in $(lsblk -d -o NAME -n | grep -v loop); do
        local device="/dev/$disk"
        log "Checking health of $device"
        smartctl -H $device || die "Failed to check disk health"
        smartctl -A $device | grep -E "^  5|^196|^197|^198" || true
    done
}

# ==================== BACKUP FUNCTIONS ====================

backup_tar() {
    local source="$1"
    local dest="${2:-$BACKUP_DIR/backup_$(date +%Y%m%d).tar.gz}"
    log "Creating tar backup of $source to $dest"
    sudo tar -czvf "$dest" "$source" || die "Failed to create tar backup"
    log "Backup completed successfully. Size: $(du -h "$dest" | cut -f1)"
}

backup_zip() {
    local source="$1"
    local dest="${2:-$BACKUP_DIR/backup_$(date +%Y%m%d).zip}"
    log "Creating zip backup of $source to $dest"
    sudo zip -r "$dest" "$source" || die "Failed to create zip backup"
    log "Backup completed successfully. Size: $(du -h "$dest" | cut -f1)"
}

backup_dd() {
    local source="$1"
    local dest="${2:-$BACKUP_DIR/disk_clone_$(date +%Y%m%d).img}"
    log "Creating disk clone of $source to $dest"
    sudo dd if="$source" of="$dest" bs=4M status=progress || die "Failed to create disk clone"
    log "Disk clone completed successfully. Size: $(du -h "$dest" | cut -f1)"
}

# ==================== AV FUNCTIONS ====================

av_scan() {
    local scan_type="$1"
    local target="${2:-/}"
    
    case "$scan_type" in
        clamav)
            log "Starting ClamAV scan on $target"
            if ! command -v clamscan &> /dev/null; then
                log "Installing ClamAV..."
                eval $INSTALL_CMD clamav clamav-daemon
                systemctl enable clamav-freshclam --now
                systemctl enable clamav-daemon --now
            fi
            sudo clamscan --recursive --infected --bell --log=/var/log/clamav/nas-scan-$(date +%Y%m%d).log "$target" || die "ClamAV scan failed"
            ;;
        maldet)
            log "Starting LMD/Maldet scan on $target"
            if ! command -v maldet &> /dev/null; then
                log "Installing Maldet..."
                eval $INSTALL_CMD linux-malware-detect
                maldet --update-ver
                maldet --update
            fi
            sudo maldet -a "$target" || die "Maldet scan failed"
            ;;
        rkhunter)
            log "Starting Rootkit Hunter scan"
            if ! command -v rkhunter &> /dev/null; then
                log "Installing RKHunter..."
                eval $INSTALL_CMD rkhunter
            fi
            sudo rkhunter --check --sk --rwo || die "RKHunter scan failed"
            ;;
        chkrootkit)
            log "Starting chkrootkit scan"
            if ! command -v chkrootkit &> /dev/null; then
                log "Installing chkrootkit..."
                eval $INSTALL_CMD chkrootkit
            fi
            sudo chkrootkit || die "chkrootkit scan failed"
            ;;
        *)
            die "Invalid AV scan type: $scan_type"
            ;;
    esac
    log "Security scan completed successfully"
}

av_clamav_schedule() {
    local target="$1"
    CRON_FILE="/etc/cron.weekly/clamav-nas-scan"
    log "Scheduling weekly ClamAV scan for $target"
    backup_file "$CRON_FILE"
    cat > "$CRON_FILE" <<EOF
#!/bin/sh
clamscan -r "$target" --bell -i --exclude-dir="^/proc|^/sys|^/dev" -l /var/log/clamav/nas-scan-$(date +%Y%m%d).log
EOF
    chmod +x "$CRON_FILE"
    log "Weekly ClamAV scan scheduled for $target"
}

av_maldet_monitor() {
    local target="$1"
    log "Enabling Maldet monitoring for $target"
    if ! command -v maldet &> /dev/null; then
        log "Installing Maldet..."
        eval $INSTALL_CMD linux-malware-detect
        maldet --update-ver
        maldet --update
    fi
    backup_file /etc/maldetect/conf.maldet
    cat > /etc/maldetect/conf.maldet <<EOF
email_alert="1"
email_addr="root@localhost"
quarantine_hits="1"
quarantine_clean="0"
scan_tmpdir_paths="/tmp /var/tmp"
scan_user_access="1"
default_monitor_mode="/usr/local/maldetect/monitor_paths"
EOF
    echo "$target" > /usr/local/maldetect/monitor_paths
    maldet --monitor /usr/local/maldetect/monitor_paths
    systemctl enable maldet --now || true
    log "Maldet monitoring enabled for $target"
}

update_av_databases() {
    log "Updating ClamAV databases..."
    if ! command -v freshclam &> /dev/null; then
        log "Installing ClamAV..."
        eval $INSTALL_CMD clamav clamav-daemon
    fi
    sudo freshclam || die "Failed to update ClamAV databases"
    
    if command -v maldet &> /dev/null; then
        log "Updating Maldet signatures..."
        sudo maldet -u || die "Failed to update Maldet signatures"
    else
        log "Maldet not installed, skipping update"
    fi
    
    if command -v rkhunter &> /dev/null; then
        log "Updating RKHunter databases..."
        sudo rkhunter --update || die "Failed to update RKHunter databases"
    else
        log "RKHunter not installed, skipping update"
    fi
    
    log "All AV databases updated successfully"
}

# ==================== SYSTEM FUNCTIONS ====================

system_update() {
    log "Updating system packages..."
    eval $UPDATE_CMD || die "Failed to update system"
    log "System packages updated successfully"
}

# ==================== STORAGE MANAGEMENT ====================

storage_manage() {
    case "$1" in
        list)
            log "Listing storage devices"
            sudo lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT,LABEL,UUID || die "Failed to list storage devices"
            ;;
        format)
            local device="$2"
            local fstype="${3:-ext4}"
            log "Formatting $device as $fstype"
            sudo mkfs.$fstype "$device" || die "Failed to format device"
            log "Device $device formatted as $fstype"
            ;;
        mount)
            local device="$2"
            local mountpoint="$3"
            log "Mounting $device to $mountpoint"
            sudo mkdir -p "$mountpoint" || die "Failed to create mountpoint"
            sudo mount -o noatime,nodiratime "$device" "$mountpoint" || die "Failed to mount device"
            log "Device $device mounted at $mountpoint"
            ;;
        umount)
            local mountpoint="$2"
            log "Unmounting $mountpoint"
            sudo umount "$mountpoint" || die "Failed to unmount"
            log "Mountpoint $mountpoint unmounted"
            ;;
        info)
            local device="$2"
            log "Showing info for $device"
            sudo hdparm -I "$device" || die "Failed to get device info"
            sudo smartctl -a "$device" || die "Failed to get SMART info"
            ;;
        *)
            die "Invalid storage command: $1"
            ;;
    esac
}

# ==================== NFS MANAGEMENT ====================

nfs_manage() {
    case "$1" in
        install)
            log "Installing NFS server..."
            eval $INSTALL_CMD $NFS_SERVICE
            systemctl enable --now $NFS_SERVICE
            log "NFS server installed and enabled"
            ;;
        add-share)
            local path="$2"
            local clients="$3"
            local options="${4:-rw,sync,no_subtree_check,no_root_squash}"
            log "Adding NFS share $path for clients $clients"
            backup_file /etc/exports
            if grep -qE "^[[:space:]]*$(printf '%q' "$path")[[:space:]]" /etc/exports; then
                sed -ri "s|^(\s*)$(printf '%q' "$path").*|\1${path} ${clients}(${options})|" /etc/exports
            else
                echo "$path $clients($options)" | sudo tee -a /etc/exports > /dev/null
            fi
            sudo exportfs -ra || die "Failed to export shares"
            sudo systemctl restart $NFS_SERVICE || die "Failed to restart NFS"
            log "NFS share added successfully"
            ;;
        *)
            die "Invalid NFS command: $1"
            ;;
    esac
}

# ==================== SAMBA MANAGEMENT ====================

samba_manage() {
    case "$1" in
        install)
            log "Installing Samba..."
            eval $INSTALL_CMD samba samba-common-bin
            systemctl enable --now smbd nmbd
            log "Samba installed and enabled"
            ;;
        add-share)
            local name="$2"
            local path="$3"
            local users="$4"
            local writable="${5:-yes}"
            log "Adding Samba share $name for path $path"
            backup_file /etc/samba/smb.conf
            echo "[$name]" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   path = $path" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   valid users = $users" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   writable = $writable" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   browsable = yes" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   guest ok = no" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   read only = no" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   create mask = 0660" | sudo tee -a /etc/samba/smb.conf > /dev/null
            echo "   directory mask = 0770" | sudo tee -a /etc/samba/smb.conf > /dev/null
            sudo mkdir -p "$path"
            sudo chown root:"$users" "$path"
            sudo chmod 2770 "$path"
            sudo systemctl restart smbd || die "Failed to restart Samba"
            log "Samba share $name added successfully"
            ;;
        *)
            die "Invalid Samba command: $1"
            ;;
    esac
}

# ==================== SSHFS MANAGEMENT ====================

sshfs_manage() {
    case "$1" in
        install)
            log "Installing SSHFS..."
            case $DISTRO in
                debian|ubuntu)
                    eval $INSTALL_CMD sshfs
                    ;;
                opensuse*)
                    eval $INSTALL_CMD fuse-sshfs
                    ;;
            esac
            modprobe fuse
            backup_file /etc/fuse.conf
            touch /etc/fuse.conf
            if grep -q '^\s*#\s*user_allow_other' /etc/fuse.conf; then
                sed -ri 's/^\s*#\s*user_allow_other/user_allow_other/' /etc/fuse.conf
            elif ! grep -q '^\s*user_allow_other' /etc/fuse.conf; then
                echo "user_allow_other" >> /etc/fuse.conf
            fi
            log "SSHFS installed and configured"
            ;;
        mount)
            local user="$2"
            local host="$3"
            local remote_path="$4"
            local local_path="$5"
            log "Mounting $user@$host:$remote_path to $local_path"
            mkdir -p "$local_path"
            sudo sshfs -o allow_other,default_permissions $user@$host:$remote_path $local_path || die "SSHFS mount failed"
            log "SSHFS mount successful"
            ;;
        *)
            die "Invalid SSHFS command: $1"
            ;;
    esac
}

# ==================== FIREWALL MANAGEMENT ====================

firewall_manage() {
    case "$FIREWALL_TYPE" in
        firewalld)
            if ! command -v firewall-cmd &> /dev/null; then
                log "Installing firewalld..."
                eval $INSTALL_CMD firewalld
                systemctl enable --now firewalld
            fi
            case "$1" in
                add-port)
                    local port="$2"
                    local proto="${3:-tcp}"
                    log "Adding firewalld port $port/$proto"
                    firewall-cmd --permanent --add-port="$port/$proto" || die "Failed to add port"
                    firewall-cmd --reload || die "Failed to reload firewall"
                    log "Port $port/$proto added"
                    ;;
                remove-port)
                    local port="$2"
                    local proto="${3:-tcp}"
                    log "Removing firewalld port $port/$proto"
                    firewall-cmd --permanent --remove-port="$port/$proto" || die "Failed to remove port"
                    firewall-cmd --reload || die "Failed to reload firewall"
                    log "Port $port/$proto removed"
                    ;;
                add-service)
                    local service="$2"
                    log "Adding firewalld service $service"
                    firewall-cmd --permanent --add-service="$service" || die "Failed to add service"
                    firewall-cmd --reload || die "Failed to reload firewall"
                    log "Service $service added"
                    ;;
                remove-service)
                    local service="$2"
                    log "Removing firewalld service $service"
                    firewall-cmd --permanent --remove-service="$service" || die "Failed to remove service"
                    firewall-cmd --reload || die "Failed to reload firewall"
                    log "Service $service removed"
                    ;;
                add-source)
                    local source="$2"
                    log "Adding firewalld source $source"
                    firewall-cmd --permanent --zone=public --add-source="$source" || die "Failed to add source"
                    firewall-cmd --reload || die "Failed to reload firewall"
                    log "Source $source added"
                    ;;
                remove-source)
                    local source="$2"
                    log "Removing firewalld source $source"
                    firewall-cmd --permanent --zone=public --remove-source="$source" || die "Failed to remove source"
                    firewall-cmd --reload || die "Failed to reload firewall"
                    log "Source $source removed"
                    ;;
                list)
                    log "Listing firewalld configuration"
                    firewall-cmd --list-all || die "Failed to list firewall configuration"
                    ;;
                *)
                    die "Invalid firewalld command"
                    ;;
            esac
            ;;
        *)
            die "Unsupported firewall type: $FIREWALL_TYPE"
            ;;
    esac
}

# ==================== FAIL2BAN MANAGEMENT ====================

fail2ban_manage() {
    case "$1" in
        install)
            log "Installing fail2ban..."
            eval $INSTALL_CMD fail2ban
            systemctl enable --now fail2ban
            backup_file /etc/fail2ban/jail.local
            cat > /etc/fail2ban/jail.local <<EOF
[DEFAULT]
bantime  = 10m
findtime  = 10m
maxretry = 5
destemail = root@localhost
action = %(action_mwl)s

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 5

[samba]
enabled = true
port = 137,138,139,445
filter = samba
logpath = /var/log/samba/log.%(netbios_name)s
maxretry = 5
EOF
            log "Fail2ban installed and configured for SSH and Samba"
            ;;
        enable-jail)
            local jail="$2"
            log "Enabling fail2ban jail $jail"
            fail2ban-client set "$jail" enabled true || die "Failed to enable jail $jail"
            systemctl restart fail2ban || die "Failed to restart fail2ban"
            log "Jail $jail enabled"
            ;;
        disable-jail)
            local jail="$2"
            log "Disabling fail2ban jail $jail"
            fail2ban-client set "$jail" enabled false || die "Failed to disable jail $jail"
            systemctl restart fail2ban || die "Failed to restart fail2ban"
            log "Jail $jail disabled"
            ;;
        status)
            log "Fail2ban status:"
            fail2ban-client status || die "Failed to get fail2ban status"
            log "Detailed jail status:"
            fail2ban-client status sshd || true
            fail2ban-client status samba || true
            ;;
        *)
            die "Invalid fail2ban command"
            ;;
    esac
}

# ==================== RAID MANAGEMENT ====================

raid_manage() {
    if ! command -v mdadm &> /dev/null; then
        log "Installing mdadm..."
        eval $INSTALL_CMD mdadm
    fi

    case "$1" in
        create)
            local level="$2"
            local devices="$3"
            local name="${4:-md0}"
            log "Creating RAID $level array $name with devices: $devices"
            mdadm --create --verbose "/dev/$name" --level="$level" --raid-devices=$(echo $devices | wc -w) $devices || die "Failed to create RAID"
            mkfs.ext4 "/dev/$name" || die "Failed to create filesystem"
            log "RAID array created successfully"
            ;;
        add)
            local array="$2"
            local device="$3"
            log "Adding device $device to array $array"
            mdadm --add "/dev/$array" "$device" || die "Failed to add device to array"
            log "Device $device added to array $array"
            ;;
        remove)
            local array="$2"
            local device="$3"
            log "Removing device $device from array $array"
            mdadm --fail "/dev/$array" "$device" && mdadm --remove "/dev/$array" "$device" || die "Failed to remove device from array"
            log "Device $device removed from array $array"
            ;;
        stop)
            local array="$2"
            log "Stopping RAID array $array"
            mdadm --stop "/dev/$array" || die "Failed to stop RAID array"
            log "RAID array $array stopped"
            ;;
        status)
            log "RAID Status:"
            cat /proc/mdstat || die "Failed to check RAID status"
            mdadm --detail --scan || die "Failed to scan RAID devices"
            ;;
        save)
            log "Saving RAID configuration"
            mdadm --detail --scan > /etc/mdadm.conf || die "Failed to save RAID config"
            ;;
        *)
            die "Invalid RAID command"
            ;;
    esac
}



# ==================== LVM MANAGEMENT ====================

lvm_manage() {
    # Check if LVM tools are installed
    if ! command -v pvcreate &> /dev/null; then
        log "Installing LVM2..."
        eval $INSTALL_CMD lvm2
    fi

    case "$1" in
        create-pv)
            local device="$2"
            log "Creating physical volume on $device"
            pvcreate "$device" || die "Failed to create physical volume"
            log "Physical volume created on $device"
            ;;
        create-vg)
            local vg_name="$2"
            local pvs="$3"
            log "Creating volume group $vg_name with PVs: $pvs"
            vgcreate "$vg_name" $pvs || die "Failed to create volume group"
            log "Volume group $vg_name created"
            ;;
        create-lv)
            local vg_name="$2"
            local lv_name="$3"
            local size="$4"
            log "Creating logical volume $lv_name in $vg_name with size $size"
            lvcreate -n "$lv_name" -L "$size" "$vg_name" || die "Failed to create logical volume"
            log "Logical volume $lv_name created"
            
            # Create filesystem on the new LV
            local lv_path="/dev/$vg_name/$lv_name"
            log "Creating ext4 filesystem on $lv_path"
            mkfs.ext4 "$lv_path" || die "Failed to create filesystem"
            ;;
        extend-lv)
            local lv_path="$2"
            local size="$3"
            log "Extending logical volume $lv_path by $size"
            lvextend -L "+$size" "$lv_path" || die "Failed to extend logical volume"
            
            # Resize filesystem
            log "Resizing filesystem"
            if mount | grep -q "$lv_path"; then
                resize2fs "$lv_path" || die "Failed to resize filesystem"
            else
                log "Warning: LV not mounted. Resize filesystem manually after mounting."
            fi
            log "Logical volume $lv_path extended by $size"
            ;;
        reduce-lv)
            local lv_path="$2"
            local size="$3"
            log "Reducing logical volume $lv_path by $size"
            
            # First reduce filesystem
            log "Reducing filesystem"
            resize2fs "$lv_path" "$size" || die "Failed to reduce filesystem"
            
            # Then reduce LV
            lvreduce -L "$size" "$lv_path" || die "Failed to reduce logical volume"
            log "Logical volume $lv_path reduced to $size"
            ;;
        list-pv)
            log "Listing physical volumes"
            pvs || die "Failed to list physical volumes"
            ;;
        list-vg)
            log "Listing volume groups"
            vgs || die "Failed to list volume groups"
            ;;
        list-lv)
            log "Listing logical volumes"
            lvs || die "Failed to list logical volumes"
            ;;
        remove-lv)
            local lv_path="$2"
            log "Removing logical volume $lv_path"
            lvremove -f "$lv_path" || die "Failed to remove logical volume"
            log "Logical volume $lv_path removed"
            ;;
        remove-vg)
            local vg_name="$2"
            log "Removing volume group $vg_name"
            vgremove "$vg_name" || die "Failed to remove volume group"
            log "Volume group $vg_name removed"
            ;;
        remove-pv)
            local pv_device="$2"
            log "Removing physical volume $pv_device"
            pvremove "$pv_device" || die "Failed to remove physical volume"
            log "Physical volume $pv_device removed"
            ;;
        *)
            die "Invalid LVM command"
            ;;
    esac
}

# ==================== ADVANCED FILESYSTEM MANAGEMENT ====================

fs_advanced_manage() {
    case "$1" in
        resize)
            local device="$2"
            local size="${3:-}"
            log "Resizing filesystem on $device"
            
            if [ -z "$size" ]; then
                # Resize to maximum
                resize2fs "$device" || die "Failed to resize filesystem"
                log "Filesystem resized to maximum on $device"
            else
                # Resize to specific size
                resize2fs "$device" "$size" || die "Failed to resize filesystem"
                log "Filesystem resized to $size on $device"
            fi
            ;;
        check)
            local device="$2"
            local fs_type="${3:-ext4}"
            log "Checking filesystem on $device"
            
            case "$fs_type" in
                ext4|ext3|ext2)
                    e2fsck -f -y "$device" || die "Filesystem check failed"
                    ;;
                xfs)
                    xfs_repair -n "$device" || die "Filesystem check failed"
                    ;;
                btrfs)
                    btrfs check "$device" || die "Filesystem check failed"
                    ;;
                *)
                    die "Unsupported filesystem type: $fs_type"
                    ;;
            esac
            log "Filesystem check completed on $device"
            ;;
        label)
            local device="$2"
            local label="$3"
            local fs_type="${4:-ext4}"
            log "Setting label '$label' on $device"
            
            case "$fs_type" in
                ext4|ext3|ext2)
                    e2label "$device" "$label" || die "Failed to set label"
                    ;;
                xfs)
                    xfs_admin -L "$label" "$device" || die "Failed to set label"
                    ;;
                btrfs)
                    btrfs filesystem label "$device" "$label" || die "Failed to set label"
                    ;;
                *)
                    die "Unsupported filesystem type: $fs_type"
                    ;;
            esac
            log "Label '$label' set on $device"
            ;;
        tune)
            local device="$2"
            local option="$3"
            local value="$4"
            log "Tuning filesystem on $device"
            
            if [[ "$option" == "reserved" ]]; then
                tune2fs -m "$value" "$device" || die "Failed to tune filesystem"
                log "Reserved blocks percentage set to $value% on $device"
            elif [[ "$option" == "mounts" ]]; then
                tune2fs -c "$value" "$device" || die "Failed to tune filesystem"
                log "Maximum mount count set to $value on $device"
            elif [[ "$option" == "interval" ]]; then
                tune2fs -i "$value" "$device" || die "Failed to tune filesystem"
                log "Check interval set to $value on $device"
            else
                die "Invalid tune option: $option"
            fi
            ;;
        defrag)
            local mountpoint="$2"
            log "Defragmenting filesystem at $mountpoint"
            
            if command -v e4defrag &> /dev/null; then
                e4defrag "$mountpoint" || log "Defragmentation completed with warnings"
            else
                log "Installing e2fsprogs for defragmentation..."
                eval $INSTALL_CMD e2fsprogs
                e4defrag "$mountpoint" || log "Defragmentation completed with warnings"
            fi
            log "Defragmentation completed for $mountpoint"
            ;;
        swap)
            local device="$2"
            local action="$3"
            
            case "$action" in
                create)
                    log "Creating swap space on $device"
                    mkswap "$device" || die "Failed to create swap"
                    swapon "$device" || die "Failed to activate swap"
                    echo "$device none swap sw 0 0" >> /etc/fstab
                    log "Swap created and activated on $device"
                    ;;
                enable)
                    log "Enabling swap on $device"
                    swapon "$device" || die "Failed to enable swap"
                    log "Swap enabled on $device"
                    ;;
                disable)
                    log "Disabling swap on $device"
                    swapoff "$device" || die "Failed to disable swap"
                    log "Swap disabled on $device"
                    ;;
                remove)
                    log "Removing swap from $device"
                    swapoff "$device" || die "Failed to disable swap"
                    sed -i "\|^$device|d" /etc/fstab
                    log "Swap removed from $device"
                    ;;
                status)
                    log "Swap status:"
                    swapon --show || die "Failed to show swap status"
                    free -h | grep -i swap
                    ;;
                *)
                    die "Invalid swap action: $action"
                    ;;
            esac
            ;;
        *)
            die "Invalid filesystem command"
            ;;
    esac
}


# ==================== NETWORK MANAGEMENT ====================

network_manage() {
    case "$1" in
        list-interfaces)
            log "Listing network interfaces"
            ip -br addr show || die "Failed to list interfaces"
            ;;
        set-ip)
            local iface="$2"
            local ip="$3"
            local netmask="${4:-24}"
            log "Setting IP $ip/$netmask on $iface"
            ip addr add "$ip/$netmask" dev "$iface" || die "Failed to set IP"
            log "IP address $ip/$netmask set on $iface"
            ;;
        set-gateway)
            local gw="$2"
            log "Setting default gateway $gw"
            ip route add default via "$gw" || die "Failed to set gateway"
            log "Default gateway set to $gw"
            ;;
        set-dns)
            local dns="$2"
            log "Setting DNS server $dns"
            echo "nameserver $dns" | tee /etc/resolv.conf > /dev/null || die "Failed to set DNS"
            log "DNS server set to $dns"
            ;;
        test)
            log "Testing network connectivity"
            ping -c 4 8.8.8.8 || die "Network test failed"
            log "Network test successful"
            ;;
        bridge)
            local name="$2"
            local ifaces="$3"
            log "Creating bridge $name with interfaces $ifaces"
            ip link add name $name type bridge || die "Failed to create bridge"
            for iface in $ifaces; do
                ip link set $iface master $name || die "Failed to add interface to bridge"
            done
            ip link set $name up || die "Failed to bring up bridge"
            log "Bridge $name created successfully"
            ;;
        bond)
            local name="$2"
            local mode="$3"
            local ifaces="$4"
            log "Creating bond $name in mode $mode with interfaces $ifaces"
            ip link add $name type bond mode $mode || die "Failed to create bond"
            for iface in $ifaces; do
                ip link set $iface master $name || die "Failed to add interface to bond"
            done
            ip link set $name up || die "Failed to bring up bond"
            log "Bond $name created successfully"
            ;;
        *)
            die "Invalid network command"
            ;;
    esac
}

# ==================== SERVICE MANAGEMENT ====================

service_manage() {
    local service="$2"
    case "$1" in
        start)
            log "Starting service $service"
            systemctl start "$service" || die "Failed to start service"
            log "Service $service started"
            ;;
        stop)
            log "Stopping service $service"
            systemctl stop "$service" || die "Failed to stop service"
            log "Service $service stopped"
            ;;
        restart)
            log "Restarting service $service"
            systemctl restart "$service" || die "Failed to restart service"
            log "Service $service restarted"
            ;;
        enable)
            log "Enabling service $service"
            systemctl enable "$service" || die "Failed to enable service"
            log "Service $service enabled"
            ;;
        disable)
            log "Disabling service $service"
            systemctl disable "$service" || die "Failed to disable service"
            log "Service $service disabled"
            ;;
        status)
            log "Status of service $service"
            systemctl status "$service" --no-pager || die "Failed to get service status"
            ;;
        mask)
            log "Masking service $service"
            systemctl mask "$service" || die "Failed to mask service"
            log "Service $service masked"
            ;;
        unmask)
            log "Unmasking service $service"
            systemctl unmask "$service" || die "Failed to unmask service"
            log "Service $service unmasked"
            ;;
        *)
            die "Invalid service command"
            ;;
    esac
}

# ==================== USER MANAGEMENT ====================

# ==================== ENHANCED USER MANAGEMENT ====================

user_manage() {
    case "$1" in
        add)
            local user="$2"
            local shell="${3:-/bin/bash}"
            log "Adding user $user with shell $shell"
            useradd -m -s "$shell" "$user" || die "Failed to add user"
            passwd "$user" || die "Failed to set password"
            
            # Create user's home directory with proper permissions
            mkdir -p "/home/$user/private"
            mkdir -p "/home/$user/shared"
            chown -R "$user:$user" "/home/$user"
            chmod 750 "/home/$user"
            chmod 700 "/home/$user/private"
            chmod 755 "/home/$user/shared"
            
            log "User $user added successfully with private/shared directories"
            ;;
        remove)
            local user="$2"
            local keep_home="${3:-no}"
            log "Removing user $user (keep home: $keep_home)"
            if [ "$keep_home" = "yes" ]; then
                userdel "$user" || die "Failed to remove user"
            else
                userdel -r "$user" || die "Failed to remove user"
            fi
            
            # Remove user from all groups in configuration
            sed -i "/:$user,/s/:$user,//" "$GROUPS_CONF"
            sed -i "/:.*,$user$/s/,$user//" "$GROUPS_CONF"
            sed -i "/:$user$/s/:$user//" "$GROUPS_CONF"
            
            log "User $user removed successfully"
            ;;
        list)
            log "Listing all users"
            echo "=== System Users ==="
            cut -d: -f1 /etc/passwd
            echo ""
            echo "=== NAS Users (with home directories) ==="
            ls /home/ | grep -v lost+found
            ;;
        passwd)
            local user="$2"
            log "Changing password for $user"
            passwd "$user" || die "Failed to change password"
            log "Password changed for $user"
            ;;
        add-to-group)
            local user="$2"
            local group="$3"
            log "Adding $user to group $group"
            usermod -aG "$group" "$user" || die "Failed to add user to group"
            
            # Update groups configuration
            if grep -q "^$group:" "$GROUPS_CONF"; then
                local current_users=$(grep "^$group:" "$GROUPS_CONF" | cut -d: -f2)
                if [ -z "$current_users" ]; then
                    sed -i "s/^$group:$/:$user/" "$GROUPS_CONF"
                elif [[ ! ",$current_users," =~ ",$user," ]]; then
                    sed -i "s/^$group:.*/&,$user/" "$GROUPS_CONF"
                fi
            else
                echo "$group:$user" >> "$GROUPS_CONF"
            fi
            
            log "User $user added to group $group"
            ;;
        remove-from-group)
            local user="$2"
            local group="$3"
            log "Removing $user from group $group"
            gpasswd -d "$user" "$group" || die "Failed to remove user from group"
            
            # Update groups configuration
            if grep -q "^$group:" "$GROUPS_CONF"; then
                local current_users=$(grep "^$group:" "$GROUPS_CONF" | cut -d: -f2)
                local new_users=$(echo ",$current_users," | sed "s/,$user,/,/g" | sed 's/^,\|,$//g')
                if [ -z "$new_users" ]; then
                    sed -i "s/^$group:.*/$group:/" "$GROUPS_CONF"
                else
                    sed -i "s/^$group:.*/$group:$new_users/" "$GROUPS_CONF"
                fi
            fi
            
            log "User $user removed from group $group"
            ;;
        list-groups)
            local user="$2"
            log "Listing groups for $user"
            groups "$user" || die "Failed to list groups"
            ;;
        lock)
            local user="$2"
            log "Locking account for $user"
            passwd -l "$user" || die "Failed to lock account"
            usermod -s /sbin/nologin "$user" || true
            log "Account $user locked"
            ;;
        unlock)
            local user="$2"
            log "Unlocking account for $user"
            passwd -u "$user" || die "Failed to unlock account"
            usermod -s /bin/bash "$user" || true
            log "Account $user unlocked"
            ;;
        info)
            local user="$2"
            log "Detailed information for user $user"
            id "$user" || die "User $user not found"
            echo ""
            echo "Home directory: $(getent passwd "$user" | cut -d: -f6)"
            echo "Shell: $(getent passwd "$user" | cut -d: -f7)"
            echo "Groups: $(groups "$user")"
            echo "Last login: $(lastlog -u "$user" | tail -1 | awk '{print $4" "$5" "$6" "$7" "$8}')"
            ;;
        *)
            die "Invalid user command"
            ;;
    esac
}



# ==================== GROUP MANAGEMENT ====================

group_manage() {
    case "$1" in
        create)
            local group="$2"
            log "Creating group $group"
            groupadd "$group" || die "Failed to create group"
            
            # Add to groups configuration
            if ! grep -q "^$group:" "$GROUPS_CONF"; then
                echo "$group:" >> "$GROUPS_CONF"
            fi
            
            # Create group directory
            mkdir -p "/mnt/nas/groups/$group"
            chmod 2770 "/mnt/nas/groups/$group"  # setgid for group inheritance
            
            log "Group $group created successfully with directory"
            ;;
        delete)
            local group="$2"
            log "Deleting group $group"
            groupdel "$group" || die "Failed to delete group"
            
            # Remove from groups configuration
            sed -i "/^$group:/d" "$GROUPS_CONF"
            
            log "Group $group deleted successfully"
            ;;
        adduser)
            local group="$2"
            local user="$3"
            log "Adding user $user to group $group"
            
            # Add to system group
            usermod -aG "$group" "$user" || die "Failed to add user to group"
            
            # Update groups configuration
            if grep -q "^$group:" "$GROUPS_CONF"; then
                local current_users=$(grep "^$group:" "$GROUPS_CONF" | cut -d: -f2)
                if [ -z "$current_users" ]; then
                    sed -i "s/^$group:$/:$user/" "$GROUPS_CONF"
                elif [[ ! ",$current_users," =~ ",$user," ]]; then
                    sed -i "s/^$group:.*/&,$user/" "$GROUPS_CONF"
                fi
            else
                echo "$group:$user" >> "$GROUPS_CONF"
            fi
            
            log "User $user added to group $group"
            ;;
        removeuser)
            local group="$2"
            local user="$3"
            log "Removing user $user from group $group"
            
            # Remove from system group
            gpasswd -d "$user" "$group" || die "Failed to remove user from group"
            
            # Update groups configuration
            if grep -q "^$group:" "$GROUPS_CONF"; then
                local current_users=$(grep "^$group:" "$GROUPS_CONF" | cut -d: -f2)
                local new_users=$(echo ",$current_users," | sed "s/,$user,/,/g" | sed 's/^,\|,$//g')
                if [ -z "$new_users" ]; then
                    sed -i "s/^$group:.*/$group:/" "$GROUPS_CONF"
                else
                    sed -i "s/^$group:.*/$group:$new_users/" "$GROUPS_CONF"
                fi
            fi
            
            log "User $user removed from group $group"
            ;;
        list)
            local group="${2:-}"
            if [ -z "$group" ]; then
                log "Listing all groups"
                echo "=== System Groups ==="
                cut -d: -f1 /etc/group
                echo ""
                echo "=== NAS Managed Groups ==="
                if [ -f "$GROUPS_CONF" ]; then
                    cat "$GROUPS_CONF"
                else
                    echo "No groups configured"
                fi
            else
                log "Listing members of group $group"
                echo "=== Members of $group ==="
                if grep -q "^$group:" "$GROUPS_CONF"; then
                    grep "^$group:" "$GROUPS_CONF" | cut -d: -f2 | tr ',' '\n'
                else
                    getent group "$group" | cut -d: -f4 | tr ',' '\n'
                fi
            fi
            ;;
        setowner)
            local group="$2"
            local owner="$3"
            log "Setting $owner as owner of group $group"
            
            # Set group ownership on group directory
            mkdir -p "/mnt/nas/groups/$group"
            chown "$owner:$group" "/mnt/nas/groups/$group"
            chmod 2770 "/mnt/nas/groups/$group"  # Setgid bit for group inheritance
            
            # Create subdirectories
            mkdir -p "/mnt/nas/groups/$group/public"
            mkdir -p "/mnt/nas/groups/$group/private"
            chown "$owner:$group" "/mnt/nas/groups/$group/*"
            chmod 2775 "/mnt/nas/groups/$group/public"
            chmod 2770 "/mnt/nas/groups/$group/private"
            
            log "Group $group ownership set to $owner"
            ;;
        *)
            die "Invalid group command"
            ;;
    esac
}



# ==================== ACCESS CONTROL POLICIES ====================

policy_manage() {
    case "$1" in
        create)
            local policy="$2"
            local group="$3"
            local path="$4"
            local permissions="${5:-r}"
            local recursive="${6:-no}"
            
            log "Creating policy $policy for group $group on path $path"
            
            # Validate path exists
            if [ ! -d "$path" ]; then
                die "Path $path does not exist"
            fi
            
            # Validate group exists
            if ! getent group "$group" > /dev/null; then
                die "Group $group does not exist"
            fi
            
            # Add to policies configuration
            echo "$policy:$group:$path:$permissions:$recursive" >> "$POLICIES_CONF"
            
            # Apply policy immediately
            apply_policy "$policy"
            
            log "Policy $policy created and applied"
            ;;
        delete)
            local policy="$2"
            log "Deleting policy $policy"
            
            # Remove from policies configuration
            sed -i "/^$policy:/d" "$POLICIES_CONF"
            
            log "Policy $policy deleted"
            ;;
        apply)
            local policy="$2"
            log "Applying policy $policy"
            apply_policy "$policy"
            ;;
        applyall)
            log "Applying all policies"
            while IFS=: read -r policy group path permissions recursive; do
                [ -z "$policy" ] && continue
                [ "$policy" = "#" ] && continue
                apply_policy "$policy"
            done < "$POLICIES_CONF"
            log "All policies applied"
            ;;
        list)
            local policy="${2:-}"
            if [ -z "$policy" ]; then
                log "Listing all policies"
                echo "=== Access Policies ==="
                if [ -f "$POLICIES_CONF" ]; then
                    column -t -s: "$POLICIES_CONF" | head -1
                    echo "------------------------------------------------------------"
                    column -t -s: "$POLICIES_CONF" | tail -n +2
                else
                    echo "No policies configured"
                fi
            else
                log "Showing details for policy $policy"
                grep "^$policy:" "$POLICIES_CONF" | while IFS=: read -r p g path perm rec; do
                    echo "Policy: $p"
                    echo "Group: $g"
                    echo "Path: $path"
                    echo "Permissions: $perm"
                    echo "Recursive: $rec"
                    echo ""
                    echo "Group members:"
                    grep "^$g:" "$GROUPS_CONF" | cut -d: -f2 | tr ',' '\n' | sed 's/^/  /'
                done
            fi
            ;;
        test)
            local user="$2"
            local path="$3"
            log "Testing access for user $user to path $path"
            
            # Get all groups the user belongs to
            user_groups=$(groups "$user" | sed 's/.* : //' | tr ' ' '|')
            
            # Check policies for each group
            while IFS=: read -r policy group target_path permissions recursive; do
                [ -z "$policy" ] && continue
                [ "$policy" = "#" ] && continue
                
                # Check if user is in this group
                if [[ "$user_groups" =~ (^|\|)$group(\||$) ]]; then
                    # Check if path matches
                    if [[ "$path" == "$target_path"* ]] || [[ "$recursive" == "yes" && "$target_path" == "$path"* ]]; then
                        echo "Policy '$policy' grants permissions '$permissions' via group '$group'"
                        echo "Effective access:"
                        
                        # Test actual permissions
                        sudo -u "$user" test -r "$path" && echo "  Read: YES" || echo "  Read: NO"
                        sudo -u "$user" test -w "$path" && echo "  Write: YES" || echo "  Write: NO"
                        sudo -u "$user" test -x "$path" && echo "  Execute: YES" || echo "  Execute: NO"
                        return
                    fi
                fi
            done < "$POLICIES_CONF"
            
            echo "No specific policy found for this path"
            ;;
        *)
            die "Invalid policy command"
            ;;
    esac
}



# ==================== FILE PERMISSION MANAGEMENT ====================

permission_manage() {
    case "$1" in
        set)
            local path="$2"
            local owner="${3:-}"
            local group="${4:-}"
            local permissions="${5:-}"
            
            log "Setting permissions for $path"
            
            if [ -n "$owner" ]; then
                chown "$owner" "$path" || die "Failed to set owner"
            fi
            
            if [ -n "$group" ]; then
                chown ":$group" "$path" || die "Failed to set group"
            fi
            
            if [ -n "$permissions" ]; then
                chmod "$permissions" "$path" || die "Failed to set permissions"
            fi
            
            log "Permissions set for $path"
            ;;
        fix)
            local path="$2"
            log "Fixing permissions recursively for $path"
            
            # Set proper directory permissions
            find "$path" -type d -exec chmod 2770 {} \;
            
            # Set file permissions
            find "$path" -type f -exec chmod 660 {} \;
            
            log "Permissions fixed for $path"
            ;;
        check)
            local path="$2"
            local user="${3:-}"
            log "Checking permissions for $path"
            
            echo "=== Permission Report for $path ==="
            echo "Ownership: $(stat -c "%U:%G" "$path")"
            echo "Permissions: $(stat -c "%a" "$path")"
            echo ""
            
            if [ -n "$user" ]; then
                echo "Access test for user $user:"
                sudo -u "$user" test -r "$path" && echo "  Read: YES" || echo "  Read: NO"
                sudo -u "$user" test -w "$path" && echo "  Write: YES" || echo "  Write: NO"
                sudo -u "$user" test -x "$path" && echo "  Execute: YES" || echo "  Execute: NO"
            fi
            ;;
        *)
            die "Invalid permission command"
            ;;
    esac
}




apply_policy() {
    local policy="$1"
    local policy_line=$(grep "^$policy:" "$POLICIES_CONF")
    
    if [ -z "$policy_line" ]; then
        die "Policy $policy not found"
    fi
    
    IFS=: read -r policy_name group path permissions recursive <<< "$policy_line"
    
    log "Applying policy $policy_name to $path for group $group"
    
    # Set group ownership
    chown -R ":$group" "$path"
    
    # Set permissions based on policy
    case "$permissions" in
        r)  # Read only
            chmod -R g+r,o-rwx "$path"
            [ "$recursive" = "yes" ] && find "$path" -type d -exec chmod g+rx {} \;
            ;;
        rw) # Read/Write
            chmod -R g+rw,o-rwx "$path"
            [ "$recursive" = "yes" ] && find "$path" -type d -exec chmod g+rwx {} \;
            ;;
        rwx) # Read/Write/Execute
            chmod -R g+rwx,o-rwx "$path"
            ;;
        none) # No access
            chmod -R g-rwx,o-rwx "$path"
            ;;
        *)
            log "Warning: Unknown permission type '$permissions', using defaults"
            chmod -R g+rx,o-rwx "$path"
            ;;
    esac
    
    # Set setgid bit on directories if recursive
    if [ "$recursive" = "yes" ]; then
        find "$path" -type d -exec chmod g+s {} \;
    fi
    
    log "Policy $policy_name applied successfully"
}

# ==================== MAIN FUNCTION ====================

main() {
    # Handle global options first
    local MONITORING=false
    local DISK_HEALTH=false
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --help|-h)
                if [[ -n "${2:-}" ]] && [[ "$2" == --* ]]; then
                    module_help "${2#--}"
                    exit 0
                else
                    show_help
                    exit 0
                fi
                ;;
            --version|-v)
                echo "Enterprise NAS Management Tool v$VERSION"
                exit 0
                ;;
            --verbose)
                VERBOSE=true
                shift
                ;;
            --monitor)
                MONITORING=true
                shift
                ;;
            --disk-health)
                DISK_HEALTH=true
                shift
                ;;
            --)
                shift
                break
                ;;
            *)
                break
                ;;
        esac
    done

    init
    
    # Check for monitoring flags
    if $MONITORING; then
        monitor_iostat 2 5
    fi
    
    if $DISK_HEALTH; then
        check_disk_health
    fi

    # Process module commands
    case "$1" in
        --backup)
            shift
            case "$1" in
                --tar)
                    shift
                    backup_tar "$1" "$2"
                    ;;
                --zip)
                    shift
                    backup_zip "$1" "$2"
                    ;;
                --dd)
                    shift
                    backup_dd "$1" "$2"
                    ;;
                *)
                    die "Invalid backup action\n$(module_help backup)"
                    ;;
            esac
            ;;
        --av)
            shift
            case "$1" in
                --clamav)
                    shift
                    av_scan "clamav" "$1"
                    ;;
                --maldet)
                    shift
                    av_scan "maldet" "$1"
                    ;;
                --rkhunter)
                    av_scan "rkhunter"
                    ;;
                --chkrootkit)
                    av_scan "chkrootkit"
                    ;;
                --update-databases)
                    update_av_databases
                    ;;
                --clamav-schedule)
                    shift
                    av_clamav_schedule "$1"
                    ;;
                --maldet-monitor)
                    shift
                    av_maldet_monitor "$1"
                    ;;
                *)
                    die "Invalid AV action\n$(module_help av)"
                    ;;
            esac
            ;;
        --system)
            shift
            system_update
            ;;
        --lvm)
            shift
            lvm_manage "$@"
            ;;
        --fs-advanced)
            shift
            fs_advanced_manage "$@"
            ;;
        --monitor)
            shift
            case "$1" in
                --iostat)
                    shift
                    monitor_iostat "$1" "$2"
                    ;;
                --netdata)
                    shift
                    monitor_netdata "$1"
                    ;;
                --disk-health)
                    check_disk_health
                    ;;
                *)
                    die "Invalid monitor action\n$(module_help monitor)"
                    ;;
            esac
            ;;
        --storage)
            shift
            storage_manage "$@"
            ;;
        --nfs)
            shift
            nfs_manage "$@"
            ;;
        --samba)
            shift
            samba_manage "$@"
            ;;
        --sshfs)
            shift
            sshfs_manage "$@"
            ;;
        --firewall)
            shift
            firewall_manage "$@"
            ;;
        --fail2ban)
            shift
            fail2ban_manage "$@"
            ;;
        --raid)
            shift
            raid_manage "$@"
            ;;
        --network)
            shift
            network_manage "$@"
            ;;
        --service)
            shift
            service_manage "$@"
            ;;
        --user)
            shift
            user_manage "$@"
            ;;
        # Add these cases to your existing switch statement in main()
        --group)
            shift
            group_manage "$@"
            ;;
        --policy)
            shift
            policy_manage "$@"
            ;;
        --permission)
            shift
            permission_manage "$@"
            ;;
        *)
            show_help
            exit 1
            ;;
    esac
}

# Initialize and run
main "$@"
